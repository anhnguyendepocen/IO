---
title: "Workshop 2"
author: "Filip Mellgren, David Hakula, Christopher Hayes"
date: '2019-04-10'
output:
  html_document:
    code_folding: hide
    df_print: kable
    highlight: zenburn
    theme: readable
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warnings = FALSE)
```

## R Markdown

```{r libraries, include = FALSE }
library(tidyverse)
library(rio)
library(ggthemes)
library(MASS)
library(stats4)

```

```{r import}
df <- import("Hypermarkets.dta")
df <- df %>% as_tibble %>% drop_na()
```

# Question 1. Premises of the analysis 
David
Explain to the retail firm what are the pros and cons of using only
big-box stores rather than all stores in your analysis. Is it plausible to
assume that there is a separate market only for big-box stores? Why
or why not?

CH: The separate market assumption is not strictly plausible in our view, but is prohibitively restrictive analyticall. 

Qualitative evidence is of substantial but inexhaustive overlap between the services offered by big-box retailers and by ‘small-box’ (plausible substitutes based on characteristics and intended use). Within this overlap there is underlap between the different constituent small retailers. Furthermore, big-boxes have distinct characteristics they don’t share with smaller stores, offering convenience and scale economies. 

Natural experiments in the US also show substitution both on the demand side and in the labour market. Haltiwanger, Jarmin & Krizan 2009 find big box entry reduces employment growth in both single unit and small chain retailers, but only with both immediate area and detailed industry in common. (https://www2.census.gov/ces/wp/2009/CES-WP-09-34.pdf) Similarly, Dube, Lester & Eidlin 2007 found lower average and aggregate retail worker earnings associated with Walmart’s entry into a county. 


Pros: 

* focuses the analysis on an important aspect of competition; it might be the case that the market constrained to big-box stores behaves differently than a market including all types of store. 
* A more narrow approach allows for a richer model of competition and profitability. 

Cons: 

* Might fail to take into account crucial asepcts of competition; if smaller stores are competing in the same market, leaving those out of the analysis might lead to severe strategic mistakes. 
* Not context specific.

To decide whether it is plausible to assume that a separate markets exists for big-box stores, five different strategies are available: Qualitative evidence, Price, Natural Experiments, Estimation of price elasticities and the Hypothetical Monopolist Test. 

Qualitative evidence: As we have no qualitative data, this approach is not suitable. One could argue, with only qualitative reasoning as basis, that big-box stores qualitatively offer similar products as other stores, and hence that big-box stores should not be considered a separat market. 

Price analysis: This type of analysis relies on observeing correlations and co-movements among substitutes. However, as this type of price data is not available for other stores than the big-box ones, this approach is not suitable. 

Natural experiments: This approach relies on exogenous shocks to price for estimating cross-price elasticities. Again, we lack data, making the approach unsuitable. 

Estimation of substitution effects: This approach relies on using revealed and stated preferences. Again, we lack this type of data.

Hypothetical Monopolist Test: In this approach, we determeine the set of products/geographical areas that impose constraints on each other's ability to exploit market power. Often a SSNIP-test (Small and Significant Nontransitory increase in Price) is used. We consider a hypothetical monopolist and ask the question: Would it be profitable to raise prices by 5-10 percent? Appled to this case, the question is "Would it be profitable for a big-box store monopolist to increase prices with 5-10 %?".

As we lack data of demand elasticities, we have to rely on reason and assumptions. As an important reason for shopping at big-box stores is price, it is likely that a significant chunk of customers would switch and go to a different type of store if prices would increase by 5-10 %. However, whether this effect is large enough to off-set the increase in profit from remaining customers in ambiguous. 


Argue about what the market is. Go to: lecture 2.
* SSNIP
* Other tests

Google scholar for sources

# Question 2. Distribution of big box stores
Chris
Show the distribution of the number of big-box stores across local markets (BR Table 2). Comment.


```{r, results='asis'}
library(stargazer)
# TODO: make latex ready
df %>% group_by(stores) %>% 
  summarise(n = n()) %>% mutate(freq = n/ sum(n), cum = cumsum(n)/sum(n)) %>%
  t() %>% round(2) %>% stargazer(title = "Distribution of stores", type = "text") # change from text to latex
```

The distribution of the number of big-box stores across local markets is bimodal, with peaks at 2 and 5. More than half of municipalities in our data have 2 or fewer big box retailers, while 9% have none at all. 22% have the maximum observed value of 5. 

# Question 3. Graphically illustrate relationship
Filip

Graphically illustrate the relationship between population and the number of stores in local markets. Moreover, show a histogram of local market population across markets with different number of hypermarkets

```{r}
  df %>% ggplot(aes(x = factor(stores), y = pop)) +
  geom_violin(alpha=0.5, scale = "count", adjust = 1) +
  theme_economist() + scale_fill_economist() + scale_color_economist() +
  labs(title = "Small municipalities can support having many stores", 
       caption = "The 'violin' plot shows how the density is distributed across the various categories.",
  tag = "Graph 1", x = "Number of stores", y = "Population (1000's)", 
  color = "Stores", fill = "Stores") 

```

```{r density}
df %>% ggplot(aes(x = pop, fill = as.character(stores),
                  color = as.character(stores) )) +
  geom_density(alpha=0.5) + scale_fill_economist() + scale_color_economist() +
  theme_economist() +
  labs(title = "Large municipalities have more stores", 
       subtitle = "Yet there exists small towns with many stores", 
  tag = "Graph 2", x = "Population (1000's)", y = "Density", 
  color = "Stores", fill = "Stores")
```
```{r save_plots}
word_margin <- 6
ggsave("Store_density_plot.png", height = 10, width = 29.7 - word_margin, units = "cm")
```

# Question 4 summary stats and descriptives
David
Present summary statistics and correlations of the number of stores and local market characteristics. Interpret your findings.
```{r summary statistics and correlations}
# TODO: make latex ready

df <- as_tibble(df)

# Begin by doing some feature engineering:
df <- df %>% mutate(close_pop = dist * pop,
              cons_pc = consumption/pop,
              cons_share = cons_pc/wage)

# pos_gpop and neg_gpop not included
summary_df <- sapply(dplyr::select(df, everything()), summary)%>% t() %>% round(2) %>%
  as_tibble(rownames = "Variable") %>% dplyr::select("Variable","Min.", "Mean", "Max.")
 
sd_df <- df %>% map(function(x) sd(x)) %>% as_tibble() %>% t() %>% 
  round(2) %>% as_tibble(rownames = "Variable") %>% rename ("Std. Dev" = V1)

corr_df <- df %>% map(function(x) cor(df$stores, x)) %>% 
  as_tibble() %>% t() %>% round(2) %>% as_tibble(rownames = "Variable") %>% 
  rename("Correlation w. stores" = V1)


summary_df <- full_join(summary_df, sd_df) %>% full_join(corr_df)
xtable::xtable(summary_df)
```
Comment on strongest correlations.

Comment on creating the consumption per capita variable.

Comment on close_pop, how it may be a bad control because it is determined by entry decisions.

Comment on including both pos_gpop and neg_gpop, may be a non linearity here.

# Question 5 Variables included in the analysis
David

Note: We excluded wage from the variable costs in the end. Marginally increased significance.
Based on the data set at hand, what variables would you include in each part of the profit function in equation (1)? Justify your answer.

In the given data set, we have the following variables: pop, dist, gpop, gpop, pos_gpop, neg_gpop, s_kids, s_pens, s_young, s_women, consumption, hprice, hsold, wage. The task is to decide which of these to include and how to classify them into the following category variables: Y (population variables), X(local market characteristics) and W(cost shifters)

We try out three different specification:

1) Classification from first group session (Filip and David):
This classification is based on the following rule: We allocate all of the variables available to the category we deem to be "best fit". 
Y: pop, dist, 
X: gpop, pos_gpop, neg_gpop, s_kids, s_pens, s_young, s_women, consumption
W: hprice, hsold, wage, 

2) Classification from "thumbed" image:
[Reason by Chris]
Y: pos_pop, neg_gpop
X: s_young, s_pens, s_women, consumption
W: hprice, wage

3) Classification best fitting with Bresnahan & Reiss:
Bresnahan & Reiss use the following setup:

Y describes market size, Z and W shift per capita demand and costs

Y:
Variables included: town population, nearby population, positive growth, negative growth, commuters out of the county 
(We include population within 10 miles of town, nearby population, to allow the population surrounding a town to increase demand.10 The growth variables-positive growth and negative growth-represent, respectively, the positive and negative growth in town population from 1970 to 1980. These growth terms capture entrants' asymmetric expectations about future market growth, as well as lags in responses to past growth (see, e.g., Hause and Du Rietz 1984; Dixit 1989). We include the variable commuters out of the county to check our market definition.)

X: 
Variables included: BIRTHS, ELD, PINC, LNHDD, HUNIT (Not used for all industries.), HVAL (Not used for all industries.), FFRAC (Not used for all industries.)
(We included per capita income in each industry's specification because consumer income usually affects the demand for goods and services. We included the number of births and the number of elderly residents in both doctors' and dentists' profit functions to control for demographic variation in the demand for and cost of health care services. Because these variables summarize both demand and cost conditions, we do not attempt to draw structural inferences about the signs of their coefficients.)

W: 
Variables included: LANDV
(We include the price of agricultural land in it to capture intermarket variation in land costs.)

Following the reasoning by Bresnahan and Reiss, we suggest the following specification:

** THIS IS THE ONE! MY ONE AND ONLY ONE! 

Y: pop, pos_gpop, neg_gpop 
As these are the variables that best capture market size in terms of potential customers over time. 

X (local market characteristics): s_kids, s_pens, s_young, s_women, consumption per capita, wage
As these are the variables that are most likely to describe the buying behavior of the potential customers: Kids and pensioners are likely to spend less, while young people and women are likely to spend more. Similarily, higher purchasing power and higher wages implies higher probability of buying more. The share of population with a store close is also included, as people living closer to stores are more likely to to engage in spontaneous shopping. 

Wage enters into variable cost

W (fixed costs): hprice, hsold, wage
The average price pre square-meter of houses sold is a proxy and captures the cost of buying the facility. 
The number of houses sold captures the search cost of finding a suitable facility. Keep this point!


CH: The BR 1991 model constructs a profit formula by relating the available variables into three separate models – market size, variable profits, and fixed costs. Variable profits and fixed costs are both parametrized such that margins are falling in the number of firms.

Variable profits are separate of the market size (population), but depend on the population’s composition and characteristics, to the extent such details bear on how much the population will buy from big box retailers. Our data covers the population shares of children, young people, women and pensioners – (inexhaustive) demographics with different disposable incomes and propensities towards the offerings of big box retailers. Children have no money but imply parents, whose typical age group is typically of a greater income, and whose spending needs and appetite for convenience may favour big box retailers. The presence of young people and pensioners may also be informative for these reasons.  We suspect the share of women might correlate with other demographic variables to bias the estimates

Fixed costs will comprise property and labour; house prices and wages are satisfactory indicators, with no plausible endogeneity concern. 

We note that, insofar as population growth correlates with the number of stores, it is driven more by negative than by positive growth. This asymmetry only makes much sense if we relate the variables to profitability, rather than strictly 'market size'. Population changes are an indicator of the dynamism of an area - people are forward looking and consider the overall prospects and trajectory of a town when making the big decision of moving their life there. This asymmetry can also allow us to simulate the distinction between entrants and incumbents in a model that otherwise treats that profitability conditions as equal.

Looking at housing market variables, hprice will be positively correlated with consumption (simultaneity), and would likely have a similar relationship with variable profit (expensive to live in a commercially thriving area). Hsold is an indicator of economic activity but is likely co-determined with consumption




# Question 6 ordered_probit script file
Filip (table)
Chris 
Specify and estimate the entry model by BR (1991) using the available
data. The do-file “BR Estim.do” is available on the course web page.
Discuss your results (BR Table 4).

Comment on the as the gs and the values of some coeffients. The signs are as we expect, except for... comment on magnitude.


Do file with the estimateion.
Ordered probit, what's the probability to observe 1, 2, 3 ,etc...
Important to specify probabilities to plug into likelihood function and plugginf in parameters that maximise probaility of observing the data.

Store in market if profit larger than 0. Observed variable is whether town in store, i.e. profit > 0. The latent variable is the profit which we don't observe.

Values she got:
pop: 1.36 and hprice: -.267 cons: .42

Note, these might have been an ordinary probit, as she spoke about the ordered probit only later.

Ordered probit
"Standard notes" from any text book in econometrics

Bresnahan and Reiss version. Slide 22 lecture 3 entry and market structure.
Profit decrease in n. Latent varibale is $\pi_n = - \beta x - \alpha_n$. y is number of stores.
$Pr(N = 0 \vert x) = Pr(\beta x - \alpha_1 + \varepsilon < 0) = 1 - \Phi(\bar{\pi_1})$
$Pr(N = 1 \vert x) = Pr(\beta x - \alpha_1 + \varepsilon > 0; \beta x - \alpha_2 + \varepsilon < 0) = \Phi(\bar{\pi}_1) - \Phi(\bar{\pi}_2)$.



gama fixed cost. Later entrants have higher fixed cost. 

arguments: a1 to a5, g1 to g5, S V and F

Only a1 and g1 to calculate profit1. Then we add more and more for profit_,2,3,4,5.

$V = \alpha_1 + X \beta - \sum_{n = 2}^N \alpha_N: a_1 - a_5$
$F = \gamma_1 + \gamma_L W_L + \sum_{n = 2}^N \gamma_N: g1 - g5$

Program gives all a_i, g_i, variable profit shifters betas: (young, ) cost shifters lambdas: (-1.84, 3.96), 


# Question 7 calculate entry thresholds
Filip
Calculate entry thresholds based on your estimated coefficients and
the average values of the exogenous variables. The entry thresholds
are given by

where the bars indicate average values. How many individuals are required for a monopolist to operate? How many individuals are required
for two, three, four and five stores, respectively, to operate? Explain.
(BR Table 5, left panel A)

The first row of Table X  shows how many (thousands of) individuals are required to sustain the number of businesses as indicated by the respective column. These values were calculated using the full set of coefficients from the maximum likelihood specifcation, including insignificant estimates despite the fact that these may mostly contain noise following Bresnahan and Reiss (1991). 

The results indicate that being the second or fourth entrant dramatically increases the competition on the market. Whereas the third and fifth entrant don't seem to change the degree of competition significantly. The dramatic change in competition incurred by the fourth entrant is surprising, and might reflect 


```{r}
# beta1*s_kids + beta2*s_young + beta3*s_pens+ beta4*s_women + beta5*cons_pc + beta6*wage
g1 <- 8.93
g2 <- 1.08
g3 <- 1.05
g4 <- 0.0695
g5 <- 0.359
a1 <- -3.62
a2 <- 0.0395
a3 <- 0.085
a4 <- 0.417
a5 <- 0.102
gL <- 0.37 # hprice
avg_hprice <- mean(df$hprice)
gL2 <- -3.81 # wages
avg_wage <- mean(df$wage)
beta1 <- -6.86 # fraction kids
avg_s_kids <- mean(df$s_kids)
beta2 <- -3.19 # fraction young
avg_s_young <- mean(df$s_young)
beta3 <- 0.213 # fraction pensioners
avg_s_pens <- mean(df$s_pens)
beta4 <- 12.5 # fraction women
avg_s_women <- mean(df$s_women)
beta5 <- -0.0882 # consumption per capita
avg_cons_pc <- mean(df$cons_pc)


S1 <- (g1 + gL* avg_hprice + gL2 * avg_wage) / (a1 + beta1*avg_s_kids + beta2*avg_s_young + beta3*avg_s_pens + beta4*avg_s_women + beta5*avg_cons_pc)
S2 <- (g1 + g2 + gL* avg_hprice + gL2 * avg_wage) / (a1 + beta1*avg_s_kids + beta2*avg_s_young + beta3*avg_s_pens + beta4*avg_s_women + beta5*avg_cons_pc - a2)
S3 <- (g1 + g2 + g3 + gL* avg_hprice + gL2 * avg_wage) / (a1 + beta1*avg_s_kids + beta2*avg_s_young + beta3*avg_s_pens + beta4*avg_s_women + beta5*avg_cons_pc - a2 - a3)
S4 <- (g1 + g2 + g3 + g4 + gL* avg_hprice + gL2 * avg_wage) / (a1 + beta1*avg_s_kids + beta2*avg_s_young + beta3*avg_s_pens + beta4*avg_s_women + beta5*avg_cons_pc - a2 - a3 - a4)
S5 <- (g1 + g2 + g3 + g4 + g5 + gL* avg_hprice + gL2 * avg_wage) / (a1 + beta1*avg_s_kids + beta2*avg_s_young + beta3*avg_s_pens + beta4*avg_s_women + beta5*avg_cons_pc - a2 - a3 - a4 - a5)
```




# Question 8: per firm entry threshold
Chris
Construct per-firm entry threshold ratios (BR Table 5, right panel A).
How does the intensity of competition change when there are two bigbox stores compared to one? How does the intensity of competition
change when there are three big-box stores compared to two, four bigbox stores compared to three, and five big-box stores compared to four?
Interpret and discuss your results.

```{r}
s2s1 <- (S2/2)/(S1)
s3s2 <- (S3/3)/(S2/2)
s4s3 <- (S4/4)/(S3/3)
s5s4 <- (S5/5)/(S4/4)
```

```{r}
Entry_threshold <- c(S1, S2, S3, S4, S5)
per_firm_entry_threshold <- Entry_threshold/(1:5)
Entry_threshold_ratios <- c(s2s1, s3s2, s4s3, s5s4, 1)

table <- rbind(Entry_threshold, per_firm_entry_threshold, Entry_threshold_ratios)
table %>% round(2) %>% as_tibble(rownames = "Estimate") %>% rename("1" = V1, "2" = V2, 
                                                      "3" = V3, "4" = V4,
                                                      "5" = V5)

```
```{r}
tmp_df <- as_tibble(cbind(Entry_threshold_ratios, c(1:5)))
tmp_df %>% ggplot(aes(x = V2, y = Entry_threshold_ratios)) +
  geom_point() + scale_fill_economist() + scale_color_economist() +
  theme_economist() +
  labs(title = "Title", 
       subtitle = "subtitle", 
       caption = "A caption can be added",
  tag = "Graph 1", x = "Population (1000's)", y = "Density")
```

The per-firm entry thresholds are increasing in the number of firms at a diminishing rate, i.e. competition intensity is increasing and concave in the number of firms. The per-firm duopoly threshold is 42% greater than the monopoly threshold, while the triopoly threshold is only 15% greater than that. Meanwhile, competition intensity is more or less flat beyond 4 firms, with a per-firm threshold ratio barely above 1 at 1.02. Moreover, while the threshold ratios flatten, the absolute marginal entry threshold increases fairly reliably until it peaks at the 4th firm (11.12k), falling to 9.06k for the 5th firm. 

# Question 9: recommendation
David
What types of local markets would you recommend the international
retail firm to enter? Why?


# Question 10 limitiations
The performed analysis relies on several assumptions. Explain the limitations of your analysis to the retail firm.

•	similar identical profit functions between firms, and 
•	no product differentiation (including in terms of variety)
•	error terms distributed i.i.d. ~ N(0,1)
•	Average profits = 0, only error term is non-zero


## Post lecture code
$\pi_{Nm} = S(Y, \lambda) V_{Nm}(X, \alpha, \beta) - F_{Nm}(W, \gamma) + \epsilon_m = \tilde{\pi}_{Nm} + \epsilon_m$

$V_{Nm} = \alpha_1 + \textbf{X}\beta  - \sum_{n = 2}^{N_m} \alpha_n$

$F_{Nm} = \gamma_1 + \gamma_L W_L +\sum_{n = 2}^{N_m} \gamma_n$

```{r}

# W is cost shifters
# hprice, p992 B & reiss

# X is local market characteristics
#per capita income in each industry's
#specification because consumer income usually affects the demand
#for goods and services. We included the number of births and the
#number of elderly residents in both doctors' and dentists' profit functions to control for #demographic variation in the demand for and
#cost of health care services.11 Because these variables summarize both
#demand and cost conditions, we do not attempt to draw structural
#inferences about the signs of their coefficients


# Y contain population variables
```




